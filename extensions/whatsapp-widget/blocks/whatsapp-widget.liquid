{% comment %}
  WhatsApp Chat Widget Block
  This block creates a floating WhatsApp chat button
{% endcomment %}

<div id="whatsapp-widget-{{ block.id }}" class="whatsapp-widget-container" data-block-id="{{ block.id }}">
  <!-- Widget will be rendered by JavaScript -->
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Configuration from block settings
    const config = {
      blockId: '{{ block.id }}',
      phoneNumber: '{{ block.settings.phone_number | default: "919999999999" }}',
      message: '{{ block.settings.message | default: "Hello! I need help with my order." }}',
      buttonText: '{{ block.settings.button_text | default: "ðŸ’¬ Chat with us" }}',
      position: '{{ block.settings.position | default: "bottom-right" }}',
      backgroundColor: '{{ block.settings.background_color | default: "#25D366" }}',
      animation: '{{ block.settings.animation | default: "pulse" }}',
      showOnMobile: {{ block.settings.show_on_mobile | default: true }},
      showOnDesktop: {{ block.settings.show_on_desktop | default: true }}
    };

    // Device detection
    function isMobile() {
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }

    // Check if should show widget
    function shouldShowWidget() {
      if (isMobile() && !config.showOnMobile) return false;
      if (!isMobile() && !config.showOnDesktop) return false;
      return true;
    }

    // Create WhatsApp widget
    function createWhatsAppWidget() {
      if (!shouldShowWidget()) return;

      const container = document.getElementById('whatsapp-widget-' + config.blockId);
      if (!container) return;

      // Position styles
      const positions = {
        'bottom-right': { bottom: '20px', right: '20px' },
        'bottom-left': { bottom: '20px', left: '20px' },
        'top-right': { top: '20px', right: '20px' },
        'top-left': { top: '20px', left: '20px' }
      };
      
      const pos = positions[config.position] || positions['bottom-right'];
      
      // Apply container styles
      Object.assign(container.style, {
        position: 'fixed',
        zIndex: '9999',
        ...pos
      });

      // Create button
      const button = document.createElement('a');
      button.href = `https://wa.me/${config.phoneNumber}?text=${encodeURIComponent(config.message)}`;
      button.target = '_blank';
      button.rel = 'noopener noreferrer';
      button.innerHTML = config.buttonText;
      
      // Button styles
      Object.assign(button.style, {
        display: 'inline-flex',
        alignItems: 'center',
        justifyContent: 'center',
        padding: '12px 20px',
        backgroundColor: config.backgroundColor,
        color: '#ffffff',
        textDecoration: 'none',
        borderRadius: '50px',
        fontSize: '16px',
        fontWeight: 'bold',
        boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
        transition: 'all 0.3s ease',
        cursor: 'pointer',
        fontFamily: 'Arial, sans-serif'
      });

      // Add animation
      if (config.animation === 'pulse') {
        button.style.animation = 'whatsapp-pulse-' + config.blockId + ' 2s infinite';
      } else if (config.animation === 'bounce') {
        button.style.animation = 'whatsapp-bounce-' + config.blockId + ' 2s infinite';
      }

      // Hover effects
      button.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.05)';
        this.style.boxShadow = '0 6px 20px rgba(0,0,0,0.25)';
      });

      button.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      });

      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes whatsapp-pulse-${config.blockId} {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }
        
        @keyframes whatsapp-bounce-${config.blockId} {
          0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
          40% { transform: translateY(-10px); }
          60% { transform: translateY(-5px); }
        }
        
        @media (max-width: 768px) {
          #whatsapp-widget-${config.blockId} a {
            padding: 10px 16px !important;
            font-size: 14px !important;
          }
        }
      `;
      document.head.appendChild(style);

      // Assemble widget
      container.appendChild(button);

      // Analytics tracking (optional)
      button.addEventListener('click', function() {
        // Track click event
        if (typeof gtag !== 'undefined') {
          gtag('event', 'whatsapp_click', {
            event_category: 'engagement',
            event_label: 'whatsapp_widget'
          });
        }
        
        // Track with Facebook Pixel if available
        if (typeof fbq !== 'undefined') {
          fbq('track', 'Contact');
        }
      });
    }

    // Initialize widget
    createWhatsAppWidget();
  });
</script>

{% schema %}
{
  "name": "WhatsApp Chat Widget",
  "target": "section_group_footer",
  "settings": [
    {
      "type": "text",
      "id": "phone_number",
      "label": "WhatsApp Phone Number",
      "default": "919999999999",
      "info": "Enter your WhatsApp number with country code (e.g., 919999999999)"
    },
    {
      "type": "text",
      "id": "message",
      "label": "Default Message",
      "default": "Hello! I need help with my order.",
      "info": "Default message that will be sent when customers click the widget"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "ðŸ’¬ Chat with us",
      "info": "Text displayed on the WhatsApp button"
    },
    {
      "type": "select",
      "id": "position",
      "label": "Widget Position",
      "default": "bottom-right",
      "options": [
        { "value": "bottom-right", "label": "Bottom Right" },
        { "value": "bottom-left", "label": "Bottom Left" },
        { "value": "top-right", "label": "Top Right" },
        { "value": "top-left", "label": "Top Left" }
      ]
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#25D366",
      "info": "Background color of the WhatsApp button"
    },
    {
      "type": "select",
      "id": "animation",
      "label": "Animation",
      "default": "pulse",
      "options": [
        { "value": "pulse", "label": "Pulse" },
        { "value": "bounce", "label": "Bounce" },
        { "value": "none", "label": "None" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_on_mobile",
      "label": "Show on Mobile",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_on_desktop",
      "label": "Show on Desktop",
      "default": true
    }
  ]
}
{% endschema %}

